#!/usr/bin/env bb

(require '[babashka.process :as process]
         '[babashka.fs :as fs]
         '[babashka.pods :as pods])

(pods/load-pod 'org.babashka/fswatcher "0.0.5")
(require '[pod.babashka.fswatcher :as fw])

;; Compile everything at start.
(process/shell "./bin/build-html")
(process/shell "./bin/compile")

(defn matches-ext? [path ext]
  (and (fs/exists? path)
       (fs/regular-file? path)
       (.endsWith path ".cljs")))

(defn cljs-handler [{:keys [path]}]
  (when (matches-ext? path "cljs")
    (try
      ;; TODO: Don't print the whole error, rather just time stamp and OK/Err.
      (process/shell (str "npx cherry compile " path))
      (catch Exception (prn error)))))

(defn html-handler [{:keys [path]}]
  (when (matches-ext? path "edn")
    (try
      ;; TODO: Don't print the whole error, rather just time stamp and OK/Err.
      (process/shell "./bin/build-html") ;; TODO: Pass arguments and build only 1.
      (catch Exception (prn error)))))

(def cljs-watcher (fw/watch "pages" cljs-handler {:recursive true}))
(def html-watcher (fw/watch "src/pages" html-handler {:recursive true}))

println "~ Watching for changes in CLJS files."

@(promise)
